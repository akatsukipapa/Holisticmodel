<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web VTuber Demo (Fixed)</title>
    <style>
        body { margin: 0; background-color: #222; overflow: hidden; font-family: sans-serif; }
        
        #input-video {
            position: absolute; bottom: 20px; right: 20px;
            width: 320px; height: 180px;
            transform: scaleX(-1); border-radius: 10px; border: 2px solid #fff; z-index: 2;
        }

        canvas { display: block; width: 100vw; height: 100vh; }

        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #00d2ff; background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px; z-index: 100;
        }

        /* 動作状況を表示するデバッグ文字 */
        #debug-info {
            position: absolute; top: 10px; left: 10px;
            color: yellow; background: rgba(0,0,0,0.5); padding: 5px; z-index: 101; pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="loading">LOADING SYSTEM...</div>
    <div id="debug-info">Initializing...</div>
    
    <video id="input-video" playsinline muted autoplay></video>

    <!-- ■ 修正点1: MediaPipeのバージョンを固定して読み込む -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic@0.5.1635989137/holistic.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3.1632432244/camera_utils.js" crossorigin="anonymous"></script>
    
    <!-- Three.js & VRM -->
    <script src="https://unpkg.com/three@0.146.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.146.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://unpkg.com/@pixiv/three-vrm@1.0.0/lib/three-vrm.min.js"></script>
    
    <!-- Kalidokit -->
    <script src="https://cdn.jsdelivr.net/npm/kalidokit@1.1.5/dist/kalidokit.umd.js"></script>

    <script>
        const VRM_FILE_PATH = './3453930163915015062.vrm'; 
        const debugInfo = document.getElementById('debug-info');

        // --- Three.js 初期化 ---
        const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.body.appendChild(renderer.domElement);

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x333333);

        const camera = new THREE.PerspectiveCamera(30.0, window.innerWidth / window.innerHeight, 0.1, 20.0);
        camera.position.set(0.0, 1.4, 3.0); 

        const light = new THREE.DirectionalLight(0xffffff);
        light.position.set(1.0, 1.0, 1.0).normalize();
        scene.add(light);
        scene.add(new THREE.AmbientLight(0x404040));

        // --- VRM読み込み ---
        let currentVrm = null;
        const loader = new THREE.GLTFLoader();
        loader.register((parser) => new THREE_VRM.VRMLoaderPlugin(parser));

        loader.load(
            VRM_FILE_PATH,
            (gltf) => {
                const vrm = gltf.userData.vrm;
                currentVrm = vrm;
                scene.add(vrm.scene);
                vrm.scene.rotation.y = Math.PI; 
                
                // 腕を少し下げる（Tポーズ緩和）
                const leftUpperArm = vrm.humanoid.getNormalizedBoneNode('leftUpperArm');
                const rightUpperArm = vrm.humanoid.getNormalizedBoneNode('rightUpperArm');
                if(leftUpperArm) leftUpperArm.rotation.z = 1.2;
                if(rightUpperArm) rightUpperArm.rotation.z = -1.2;

                document.getElementById('loading').style.display = 'none';
                debugInfo.innerText = "VRM Loaded. Waiting for AI...";
                console.log("VRM Loaded!");
            },
            (progress) => console.log('Loading VRM...', 100.0 * (progress.loaded / progress.total), '%'),
            (error) => {
                console.error(error);
                debugInfo.innerText = "Error loading VRM.";
            }
        );

        // --- MediaPipe Holistic 設定 ---
        const videoElement = document.getElementById('input-video');

        // ■ 修正点2: locateFileのURLもバージョン指定版にする
        const holistic = new Holistic({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/holistic@0.5.1635989137/${file}`;
        }});

        holistic.setOptions({
            modelComplexity: 1,
            smoothLandmarks: true,
            minDetectionConfidence: 0.7,
            minTrackingConfidence: 0.7,
            refineFaceLandmarks: true
        });

        holistic.onResults(onResults);

        // --- 描画ループ ---
        function onResults(results) {
            // 動作確認用：左上の文字を更新
            debugInfo.innerText = "Tracking Active! (" + new Date().toLocaleTimeString() + ")";

            animateVRM(results);
            renderer.render(scene, camera);
        }

        function animateVRM(results) {
            if (!currentVrm) return;

            // Pose, Face, Hand の計算
            const rigidPose = Kalidokit.Pose.solve(results.poseLandmarks, results.poseWorldLandmarks, {
                runtime: 'mediapipe',
                video: videoElement
            });
            const rigidFace = Kalidokit.Face.solve(results.faceLandmarks, {
                runtime: 'mediapipe',
                video: videoElement
            });
            const rigidLeftHand = Kalidokit.Hand.solve(results.leftHandLandmarks, "Left");
            const rigidRightHand = Kalidokit.Hand.solve(results.rightHandLandmarks, "Right");

            // 回転適用関数
            const rigRotation = (name, rotation, dampener = 1, lerpAmount = 0.3) => {
                if (!rotation) return;
                const part = currentVrm.humanoid.getNormalizedBoneNode(name);
                if (!part) return;
                
                const euler = new THREE.Euler(
                    rotation.x * dampener, 
                    rotation.y * dampener, 
                    rotation.z * dampener, 
                    rotation.rotationOrder || "XYZ"
                );
                const quaternion = new THREE.Quaternion().setFromEuler(euler);
                part.quaternion.slerp(quaternion, lerpAmount);
            };

            // Body
            if (rigidPose) {
                rigRotation("hips", rigidPose.Hips.rotation, 0.7);
                rigRotation("chest", rigidPose.Spine, 0.25, .3);
                rigRotation("spine", rigidPose.Spine, 0.45, .3);
                rigRotation("rightUpperArm", rigidPose.RightUpperArm, 1, .3);
                rigRotation("rightLowerArm", rigidPose.RightLowerArm, 1, .3);
                rigRotation("leftUpperArm", rigidPose.LeftUpperArm, 1, .3);
                rigRotation("leftLowerArm", rigidPose.LeftLowerArm, 1, .3);
            }

            // Hands
            if (rigidLeftHand) rigRotation("leftHand", rigidLeftHand.LeftWrist);
            if (rigidRightHand) rigRotation("rightHand", rigidRightHand.RightWrist);

            // Face
            if (rigidFace) {
                rigRotation("neck", rigidFace.head, 0.7);
                if(currentVrm.expressionManager){
                    const openAmount = rigidFace.mouth.shape.A;
                    currentVrm.expressionManager.setValue('aa', openAmount);
                    currentVrm.expressionManager.setValue('blinkLeft', 1 - rigidFace.eye.l);
                    currentVrm.expressionManager.setValue('blinkRight', 1 - rigidFace.eye.r);
                }
            }
            
            currentVrm.update(1.0 / 30.0);
        }

        // --- カメラ起動 ---
        const cameraUtils = new Camera(videoElement, {
            onFrame: async () => {
                await holistic.send({image: videoElement});
            },
            width: 640,
            height: 480
        });
        cameraUtils.start();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>
